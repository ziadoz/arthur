---
- name: Add PHP PPA
  apt_repository:
    repo: ppa:ondrej/php


- name: Install PHP Packages
  apt:
    name:
      - php{{ php_version }}
      - php{{ php_version }}-cli
      - php{{ php_version }}-common
      - php{{ php_version }}-curl
      - php{{ php_version }}-dev
      - php{{ php_version }}-fpm
      - php{{ php_version }}-gd
      - php{{ php_version }}-intl
      - php{{ php_version }}-json
      - php{{ php_version }}-mbstring
      - php{{ php_version }}-mysql
      - php{{ php_version }}-readline
      - php{{ php_version }}-xml
      - php{{ php_version }}-zip
    state: latest
    update_cache: yes

  # https://github.com/oerdnj/deb.sury.org/wiki/Frequently-Asked-Questions#why-are-some-packages-named-phpxy--and-some-php-
- name: Install PECL Packages
  apt:
    name:
      - php-imagick
      - php-redis
      - php-xdebug
    state: latest
    update_cache: yes

- name: Update PHP Configuration
  lineinfile:
    dest: /etc/php/{{ php_version }}/fpm/php.ini
    regexp: '^;?{{ item.key }}\s+=\s+'
    line: '{{ item.key }} = {{ item.value }}'
    state: present
    backup: yes
  with_dict: "{{ php_config }}"
  notify: Restart PHP FPM

- name: Update PHP CLI Configuration
  lineinfile:
    dest: /etc/php/{{ php_version }}/cli/php.ini
    regexp: '^;?{{ item.key }}\s+=\s+'
    line: '{{ item.key }} = {{ item.value }}'
    state: present
    backup: yes
  with_dict: "{{ php_cli_config }}"
  notify: Restart PHP FPM

- name: Check Composer Installed
  shell: which composer
  register: composer_installed
  ignore_errors: yes

- name: Download Composer Installer
  get_url:
    url: https://getcomposer.org/installer
    dest: /home/{{ user_account }}/composer-setup.php
  when: composer_installed.rc == 1

- name: Run Composer Installer
  shell: php /home/{{ user_account }}/composer-setup.php --quiet --install-dir=/usr/local/bin --filename=composer
  when: composer_installed.rc == 1

- name: Make Composer Executable
  file:
    path: /usr/local/bin/composer
    owner: root
    group: root
    mode: 0777
  when: composer_installed.rc == 1

- name: Update Composer
  shell: composer self-update
  when: composer_installed.rc == 0

- name: Setup Composer Environment
  copy:
    src: composer.sh
    dest: /etc/profile.d
    owner: root
    group: root
    mode: 0644

- name: Cleanup Composer Setup
  file:
    path: /home/{{ user_account }}/composer-setup.php
    state: absent

- name: Check XDebug Installed
  stat:
    path: /etc/php/{{ php_version }}/mods-available/xdebug.ini
  register: xdebug_installed
  when: xdebug

- name: Copy XDebug Configuration
  template:
    src: xdebug.ini.j2
    dest: /etc/php/{{ php_version }}/mods-available/xdebug.ini
    owner: root
    group: root
    mode: 0644
  when: xdebug and xdebug_installed.stat.exists == false

- name: Symlink XDebug Configuration
  file:
    src: /etc/php/{{ php_version }}/mods-available/xdebug.ini
    dest: /etc/php/{{ php_version }}/fpm/conf.d/20-xdebug.ini
    state: link
    owner: root
    group: root
    mode: 0777
  notify: Restart PHP FPM
  when: xdebug

- name: Configure UFW
  ufw:
    rule: allow
    port: "{{ xdebug_port }}"
  when: xdebug
